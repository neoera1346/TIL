# EC2

- Elastic Compute Cloudd의 약자로, 한 대의 (가상)컴퓨터를 임대해주는 것이다.

- 24시간 내내 돌아가는 컴퓨터가 있어야 서버를 구동할 수 있는데 그것을 AWS에서 대여해주는 것이 바로 EC2이다.

- 또한 개발하는 프로젝트의 규모가 커진다면 서버의 자원을 별도로 증설할 필요없이 트래픽에 따라 자원을 유동적으로 할당해주니 우리는 개발만하고 서버에 관해서는 신경쓸 필요가 없어진다.

---

# Creating Server App

1. 노드 서버 앱을 먼저 생성해야한다.
2. `mkdir [프로젝트명]`으로 새 프로젝트를 만들어 코드를 연다.
3. `npm init`으로 `package.json`을 생성해준다.
4. 서버를 열기 위해 `npm install express`를 통해 express를 설치한다.

```js
const express = require("express");
const app = express();

app.use("/", (req, res) => {
	res.send("Hello World");
});

app.listen(5000, () => {
	console.log("listening server");
});
```

5. 이후 해당 포트의 로컬호스트로 접속하면 해당 내용이 보이게 된다. 그러나, 우리는 이 사이트가 누구나 접속할 수 있는 배포된 사이트이길 바란다.
6. 그러기 위해선 `Git`을 사용해 깃허브 원격저장소를 통해서 EC2에 업로드 해주어야 한다.

---

# Starting Instance

1. EC2의 '인스턴스' → '인스턴스 시작' 버튼을 누른다.
2. Amazon Machine Image(AMI)를 선택한다. Ubuntu를 사용한다.
3. 인스턴스 유형은 과금되지 않기 위해 꼭 프리티어를 사용한다.
4. '기존 키 페어' 혹은 '새 키 페어 생성'을 해야한다. 해당 가상 컴퓨터에 접속할 수 있는 프리이빗 키를 저장을 해야하는 과정이다. **키 페어를 꼭 다운로드 해야한다.**
5. 인스턴스 종류가 많다면, 인스턴스별로 별칭을 만들 수 있다.
6. '인스턴스 시작' 옆에 위치한 '연결' 버튼을 누르면, 인스턴스 접근 방법을 자세히 설명해준다.
7. 만약 .ssh 폴더가 없다면, `mkdir .ssh`로 새 폴더를 만들어준다.
8. 4번 과정에서 받은 `.pem` 키를 해당 폴더로 옮겨야한다.

```
$ mv ~/Downloads/[파일명.pem] ./
```

9. 이후 `.ssh`에 권한을 부여해준다.

```
chmod 400 [파일명.pem]
```

10. 퍼블릭 DNS를 사용하여 인스턴스에 연결한다.

```
ssh -i [파일명.pem] ubuntu@[퍼블릭DNS]
```

11. 위 작업까지 완료하면 우분투에 접속이 된다. 여기에는 Git만 설치된 상태이다.

---

# Environment Settings

1. 우분투 환경에 노드와 `npm`을 설치한다.

```
$ sudo apt update
$ sudo apt install nodejs
$ sudo apt install npm install
$ nodejs -v
$ npm -v
```

2. 깃허브에 올린 서버 앱을 그대로 EC2 서버에 클론해온다.
3. 클론한 폴더로 이동하고나서 `npm install`을 통해 `package.json`에 있는 모듈들을 설치한다.
4. EC2의 보안 설정도 해주어야 한다. 현재 상태에서는 퍼블릭 IP로 접속이 아직 불가능하다.

---

# Security Group

1. 인스턴스의 가장 오른쪽으로 가면 보안 그룹 항목이 있다.
2. 인바운드/아웃바운드 규칙 설정을 해야한다.
   - 유형: SSH, 포트 범위: 22, 소스: 사용자 지정
   - 유형: HTTP, 포트 범위: 80, 소스: 위치 무관
   - 유형: 사용자 지정 TCP, 포트 범위: 5000, 소스: 위치 무관

이후 터미널을 끄면 서버도 같이 꺼지게 된다. 서버를 계속 켜놓을 수 있는 `PM2`라는 기능이 있다.

---

# PM2

Process Manager Tool(PM2) 설치하는 방법은 다음과 같다.

```
$ npm install pm2 -g
```

하지만 -g로 하는 글로벌 설치는 권한을 필요로 하기 때문에, `sudo`로 설치해야 한다.

```
$ sudo npm install pm2 -g
```

다음은, 서버가 실행됬을 때 엔트리 포인트를 pm2로 시작해주어야 한다.

```
$ pm2 start index.js
```

다음 명령어를 통해서 앱이 잘 작동되고 있는지 확인할 수 있다.

```
$ pm2 list
```

그럼, `exit`을 통해 우분투 터미널을 나가더라도 서버는 계속 켜져있어 사이트에 접속이 가능해진다.
